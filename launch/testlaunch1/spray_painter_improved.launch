<launch>
    <!-- 改进的喷涂系统启动文件 - 可与boat1.launch配合使用 -->
    
    <!-- 参数配置 -->
    <arg name="model_path" default="$(find ship_painter)/models/test.stl"/>
    <arg name="use_simple_planner" default="false"/>  <!-- 选择规划器类型 -->
    <arg name="enable_visual_feedback" default="true"/>
    
    <!-- 从参数服务器读取船体位置（由boat1.launch设置） -->
    <arg name="model_x" default="5.0"/>
    <arg name="model_y" default="0.0"/>
    <arg name="model_z" default="0.0"/>
    
    <!-- 等待MAVROS就绪 -->
    <node name="wait_for_mavros" pkg="rostopic" type="rostopic" 
          args="echo -n 1 /iris_0/mavros/state" output="screen"/>
    
    <!-- 视觉处理节点 -->
    <group if="$(arg enable_visual_feedback)">
        <node name="visual_processor" pkg="ship_painter" type="visual_processor_node" 
              output="screen" launch-prefix="bash -c 'sleep 3; $0 $@'">
            <param name="camera_topic" value="/iris_0/camera/image_raw"/>
            <param name="depth_topic" value="/iris_0/camera/depth/image_raw"/>
            <param name="pointcloud_topic" value="/iris_0/velodyne_points"/>
            <param name="target_distance" value="0.5"/>
            <param name="distance_tolerance" value="0.05"/>
            <param name="enable_visualization" value="true"/>
        </node>
    </group>
    
    <!-- 选择启动的节点类型 -->
    <group if="$(arg use_simple_planner)">
        <!-- 使用集成的智能系统 -->
        <node name="integrated_spray_painter" pkg="ship_painter" 
              type="ship_painter_integrated_node" output="screen"
              launch-prefix="bash -c 'sleep 5; $0 $@'">
            <param name="model_path" value="$(arg model_path)"/>
            <param name="model_x" value="$(arg model_x)"/>
            <param name="model_y" value="$(arg model_y)"/>
            <param name="model_z" value="$(arg model_z)"/>
            <param name="target_distance" value="0.5"/>
            <param name="max_velocity" value="0.5"/>
            <param name="waypoint_tolerance" value="0.15"/>
        </node>
    </group>
    
    <group unless="$(arg use_simple_planner)">
        <!-- 使用完整的PathPlanner系统 -->
        <node name="ship_painter_node" pkg="ship_painter" 
              type="ship_painter_node" output="screen"
              launch-prefix="bash -c 'sleep 5; $0 $@'">
            <param name="model_path" value="$(arg model_path)"/>
            <param name="model_x" value="$(arg model_x)"/>
            <param name="model_y" value="$(arg model_y)"/>
            <param name="model_z" value="$(arg model_z)"/>
            
            <!-- 完整路径规划参数 -->
            <param name="spray_radius" value="0.125"/>
            <param name="spray_distance" value="0.5"/>
            <param name="layer_height" value="0.25"/>
            <param name="voxel_resolution" value="0.03"/>
            <param name="max_height_variation" value="0.025"/>
            
            <!-- 飞行控制参数 -->
            <param name="takeoff_height" value="2.0"/>
            <param name="flight_speed" value="0.5"/>
            <param name="approach_speed" value="0.3"/>
            <param name="waypoint_tolerance" value="0.15"/>
            <param name="orientation_tolerance" value="0.15"/>
            
            <!-- 视觉反馈参数 -->
            <param name="use_visual_feedback" value="$(arg enable_visual_feedback)"/>
            <param name="visual_timeout" value="1.0"/>
        </node>
    </group>
    
    <!-- RViz可视化 -->
    <node name="rviz_spray_painter" pkg="rviz" type="rviz" 
          args="-d $(find ship_painter)/rviz/ship_painter.rviz"
          launch-prefix="bash -c 'sleep 8; $0 $@'"/>
    
    <!-- 系统状态监控 -->
    <node name="system_monitor" pkg="rostopic" type="rostopic" 
          args="echo /iris_0/mavros/state" output="screen" if="false"/>
    
    <!-- 参数加载 -->
    <rosparam file="$(find ship_painter)/config/spray_params.yaml" command="load" if="false"/>
    
    <!-- 调试工具 -->
    <group if="true">
        <node name="rqt_console" pkg="rqt_console" type="rqt_console" 
              launch-prefix="bash -c 'sleep 10; $0 $@'" if="false"/>
        
        <!-- 显示关键话题 -->
        <node name="topic_monitor" pkg="rostopic" type="rostopic" 
              args="hz /iris_0/mavros/local_position/pose" output="screen" if="false"/>
    </group>
    
</launch>