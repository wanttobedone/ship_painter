<launch>
    <!-- 从参数服务器读取模型位置，如果不存在则使用默认值 -->
    <arg name="model_x" default="5.0"/>
    <arg name="model_y" default="0"/>
    <arg name="model_z" default="0"/>
    
    <!-- 调试参数：禁用表面重建以避免段错误 -->
    <arg name="reconstruction_method" default="0"/>  <!-- 0=禁用重建 -->
    <arg name="poisson_depth" default="6"/>
    
    <!-- 启动路径规划节点 -->
    <group ns="iris_0">
        <node name="ship_painter_node" pkg="ship_painter" type="ship_painter_node" output="screen">
            <!-- STL模型路径 -->
            <param name="model_path" value="$(find ship_painter)/models/test.stl"/>
            
            <!-- 模型位置 -->
            <param name="model_x" value="$(arg model_x)"/>
            <param name="model_y" value="$(arg model_y)"/>
            <param name="model_z" value="$(arg model_z)"/>
            
            <!-- 路径规划参数 -->
            <param name="offset_distance" value="1.0"/>
            <param name="slice_interval" value="0.3"/>
            <param name="slice_thickness" value="0.25"/>
            
            <!-- 法向量估计参数 -->
            <param name="normal_k_search" value="30"/>
            <param name="normal_search_radius" value="0.1"/>
            <param name="voxel_resolution" value="0.03"/>
            
            <!-- 飞行参数 -->
            <param name="takeoff_height" value="2.0"/>
            <param name="waypoint_tolerance" value="0.2"/>
            <param name="orientation_tolerance" value="0.15"/>
            <param name="flight_speed" value="0.8"/>
            
            <!-- 姿态控制参数 -->
            <param name="smooth_orientation" value="true"/>
            <param name="orientation_transition_rate" value="0.1"/>
            
            <!-- 表面重建参数 - 安全设置 -->
            <param name="reconstruction_method" value="$(arg reconstruction_method)"/>
            <param name="poisson_depth" value="$(arg poisson_depth)"/>
            <param name="poisson_point_weight" value="4.0"/>
            <param name="poisson_samples_per_node" value="1"/>
            
            <!-- 通用重建参数 -->
            <param name="reconstruction_resolution" value="0.01"/>
            <param name="enable_surface_smoothing" value="true"/>
            <param name="smoothing_iterations" value="3"/>
            
            <!-- 轮廓生成参数 -->
            <param name="use_reconstructed_contour" value="false"/>  <!-- 禁用重建轮廓 -->
            <param name="contour_angle_resolution" value="0.5"/>
            <param name="min_contour_points" value="12"/>
            
            <!-- 质量控制参数 -->
            <param name="max_mesh_triangles" value="500000"/>
            <param name="min_triangle_area" value="0.0001"/>
            <param name="surface_deviation_threshold" value="0.05"/>
            
            <!-- 性能优化参数 -->
            <param name="parallel_processing" value="true"/>
            <param name="memory_optimization" value="true"/>
            <param name="adaptive_sampling" value="true"/>
            
            <!-- 文件保存参数 - 禁用以避免I/O问题 -->
            <param name="save_reconstructed_mesh" value="false"/>
            <param name="save_reconstructed_pointcloud" value="false"/>
            
            <param name="frame_id" value="world"/>
        </node>
    </group>
    
    <!-- 启动 RViz 可视化 -->
    <node name="rviz" pkg="rviz" type="rviz" args="-d $(find ship_painter)/rviz/ship_painter.rviz"/>
    
    <!-- TF变换：world到map -->
    <node pkg="tf" type="static_transform_publisher" name="world_to_map" 
          args="0 0 0 0 0 0 world map 100"/>
    
    <!-- 诊断信息显示 -->
    <node name="rqt_console" pkg="rqt_console" type="rqt_console" 
          launch-prefix="bash -c 'sleep 2; $0 $@' "/>
</launch>