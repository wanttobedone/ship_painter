<!-- 路径规划与轨迹跟踪节点，发布给底层飞控数据是期望位置/速度/加速度/姿态 -->
<launch>
    
    <arg name="traverse_clockwise" default="true"/><!--true顺时针，false逆时针-->

    <!-- 启动路径规划节点 -->
    <!--group ns="iris_0"-->
        <node name="ship_painter_node" pkg="ship_painter" type="ship_painter_node" output="screen">
            <!--虚拟环境话题 暂时改了/iris_0-->
            <param name="mavros_ns" value="/mavros"/>
            <!-- STL模型路径 -->
            <param name="model_path" value="$(find ship_painter)/models/test.stl"/>

            <!-- 路径规划参数 -->
            <param name="alpha_shape_value" value="5"/>
            <param name="target_sample_count" value="1000000"/>
            <param name="path_offset_distance" value="5.0"/> <!--真实世界中模型位于无人机前方几米处-->
            <!--步长设置-->
            <param name="resample_spacing" value="0.01" type="double" />
            <param name="flight_speed" value="0.6"/>        <!-- 巡航速度 (m/s) -->
            <param name="transition_speed" value="0.003"/>    <!-- 层间过渡速度 (m/s) -->

            <!-- rviz中模型位置显示参数 -->
            <param name="display_model_x" value="3.75"/>
            <param name="display_model_y" value="-0.56"/>
            <param name="display_model_z" value="0"/>
            
            <!-- 喷涂参数 -->
            <param name="spray_distance" value="0.5"/>
            <param name="layer_height" value="0.5"/>

            <!-- 航点遍历方向参数 -->
            <param name="/ship_painter/traverse_clockwise" value="$(arg traverse_clockwise)"/>

            <!-- 点云可视化设置 -->
            <param name="enable_spray_visualization" value="true"/>

            <!-- Clipper -->
            <param name="use_clipper_offset" value="true"/>
            <param name="clipper_offset_precision" value="1.0"/>
            <param name="min_offset_segment_length" value="0.001"/>
            <!--法向量平滑插值是否开启-->
            <param name="enable_normal_smoothing" value="false"/>
            
            <!-- 法向量估计参数 -->
            <param name="voxel_resolution" value="0.03"/>    <!-- 体素大小0.03 -->
            <!-- 姿态控制参数 -->
            <param name="use_position_control" value="true"/>
            
            <!-- 飞行参数 - 针对姿态控制优化 -->
            <param name="takeoff_height" value="2.0"/>
            <param name="waypoint_tolerance" value="0.2"/>   <!-- 减小位置容差，暂未用到 -->
            <param name="orientation_tolerance" value="0.15"/><!-- 姿态容差(约8.5度) -->
            
            <param name="frame_id" value="world"/>
        </node>
        <!-- B样条轨迹服务器 -->
        <!-- 先启动深度相机 -->
<!-- <include file="$(find realsense2_camera)/launch/rs_camera.launch">
    <arg name="align_depth" value="true"/>
    <arg name="enable_pointcloud" value="false"/>
</include> -->

<!-- trajectory_server节点 -->
    <node pkg="ship_painter" type="trajectory_server_node" 
        name="trajectory_server" output="screen">
        
        <param name="mavros_ns" value="/mavros" />
        
        <!--深度控制参数 -->
        
        <!-- 功能开关 -->
        <param name="enable_depth_correction" value="false" type="bool"/>
        
        <!-- 目标距离（米） -->
        <param name="target_distance" value="0.6" type="double"/>
        
        <!-- PID参数（从保守值开始） -->
        <param name="distance_kp" value="0.9" type="double"/>
        <param name="distance_ki" value="0.0" type="double"/>
        <param name="distance_kd" value="0.0" type="double"/>
        
        <!-- 修正限制（米） -->
        <param name="max_correction" value="0.2" type="double"/>
        
        <!-- 相机偏移参数（需要实际测量！）-->
        <!-- 
            机体坐标系定义：
            X轴：前（正值=相机在飞控前方）
            Y轴：右（正值=相机在飞控右侧）
            Z轴：下（正值=相机在飞控下方）
            
            示例：相机在飞控前方10cm，中线上，上方5cm
        -->
        <param name="camera_offset_x" value="0.10" type="double"/>  <!-- 前方10cm -->
        <param name="camera_offset_y" value="0.00" type="double"/>  <!-- 中线 -->
        <param name="camera_offset_z" value="-0.05" type="double"/> <!-- 上方5cm -->
        
        <!--深度数据检查参数  -->
        <param name="depth_timeout" value="0.5" type="double"/>           <!-- 超时500ms -->
        <param name="depth_min_range" value="0.3" type="double"/>         <!-- 最小30cm -->
        <param name="depth_max_range" value="2.0" type="double"/>         <!-- 最大2m -->
        <param name="depth_jump_threshold" value="0.5" type="double"/>    <!-- 突变阈值50cm -->
        
        <!-- 调试输出 -->
        <param name="debug_output" value="true" type="bool"/>

        <!-- 投影驱动参数 -->
        <param name="search_window" value="2.0" type="double"/>
        <param name="lookahead_time" value="0.3" type="double"/>
        <param name="max_backward_tolerance" value="0.5" type="double"/>

        <!-- 导纳控制参数 -->
        <param name="offset_max" value="0.5" type="double"/>
        <param name="offset_leak_rate" value="0.002" type="double"/>

        <!-- RANSAC参数 -->
        <param name="ransac_max_iterations" value="100" type="int"/>
        <param name="ransac_distance_threshold" value="0.02" type="double"/>
        <param name="min_inliers" value="100" type="int"/>
        
    </node>
    <!--/group-->
    
    <!-- 启动 RViz 可视化 -->
    <node name="rviz" pkg="rviz" type="rviz" args="-d $(find ship_painter)/rviz/ship_painter_VINS.rviz"/>
    
    <!-- TF变换：world到map -->
    <node pkg="tf" type="static_transform_publisher" name="world_to_map" 
          args="0 0 0 0 0 0 world map 100"/>
    
    <!-- 诊断信息显示 -->
    <!--node name="rqt_console" pkg="rqt_console" type="rqt_console" 
          launch-prefix="bash -c 'sleep 2; $0 $@' "/-->
</launch>