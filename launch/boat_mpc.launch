<launch>
    <!--
    说明: 此launch文件使用MPC控制器替代原有的trajectory_server

    使用方法:
    1. 先启动仿真: roslaunch ship_painter boat.launch
    2. 再启动此文件: roslaunch ship_painter boat_mpc.launch

    前置条件:
    - 已安装Acados
    - 已运行 mpc_gen/generate_mpc.py 生成求解器代码
    - 已将 c_generated_code 复制到 src/mpc/
    - 已成功编译 (catkin_make)

    -->

    <arg name="traverse_clockwise" default="true"/><!--true顺时针，false逆时针-->
    <arg name="use_depth_camera" default="true"/>
    <arg name="mavros_ns" default="/mavros"/>

    <!-- 路径规划节点 (与原boat2.launch相同) -->
    <node name="ship_painter_node" pkg="ship_painter" type="ship_painter_node" output="screen">
        <param name="mavros_ns" value="$(arg mavros_ns)"/>

        <!-- STL模型路径 -->
        <param name="model_path" value="$(find ship_painter)/models/model4cube.stl"/>

        <!-- 路径规划参数 -->
        <param name="alpha_shape_value" value="2"/>
        <param name="target_sample_count" value="500000"/>
        <param name="path_offset_distance" value="5.0"/>

        <!-- 步长设置 -->
        <param name="resample_spacing" value="0.01" type="double" />
        <param name="flight_speed" value="0.3"/>
        <param name="transition_speed" value="0.003"/>

        <!-- rviz中模型位置显示参数 -->
        <param name="display_model_x" value="3.75"/>
        <param name="display_model_y" value="-0.56"/>
        <param name="display_model_z" value="0"/>

        <!-- 喷涂参数 -->
        <param name="spray_distance" value="0.5"/>
        <param name="layer_height" value="0.25"/>

        <!-- 航点遍历方向参数 -->
        <param name="/ship_painter/traverse_clockwise" value="$(arg traverse_clockwise)"/>

        <!-- 点云可视化设置 -->
        <param name="enable_spray_visualization" value="true"/>

        <!-- Clipper -->
        <param name="use_clipper_offset" value="true"/>
        <param name="clipper_offset_precision" value="1.0"/>
        <param name="min_offset_segment_length" value="0.001"/>

        <!-- 法向量平滑插值 -->
        <param name="enable_normal_smoothing" value="false"/>

        <!-- 法向量估计参数 -->
        <param name="voxel_resolution" value="0.03"/>

        <!-- 姿态控制参数 -->
        <param name="use_position_control" value="true"/>

        <!-- 飞行参数 -->
        <param name="takeoff_height" value="2.0"/>
        <param name="waypoint_tolerance" value="0.2"/>
        <param name="orientation_tolerance" value="0.15"/>

        <param name="frame_id" value="world"/>
    </node>

    <!-- 深度相机 (可选) -->
        <!-- <group if="$(arg use_depth_camera)">
            <include file="$(find realsense2_camera)/launch/rs_camera.launch">
                <arg name="align_depth" value="true"/>
                <arg name="enable_pointcloud" value="false"/>
            </include>
        </group> -->

    <!-- MPC控制器 (替代原trajectory_server) -->
    <node pkg="ship_painter" type="mpc_runner_node"
        name="mpc_runner" output="screen">

        <!-- Acados库路径 -->
        <env name="LD_LIBRARY_PATH" value="$(env HOME)/acados/lib:$(optenv LD_LIBRARY_PATH)"/>

        <!-- MAVROS命名空间 -->
        <param name="mavros_ns" value="$(arg mavros_ns)" />

        <!-- MPC物理参数 (必须与generate_mpc.py一致) -->
        <param name="mass" value="1.5" type="double"/>
        <param name="thrust_max" value="27.0" type="double"/>
        <param name="thrust_min" value="2.0" type="double"/>

        <!-- 控制频率 (Hz) -->
        <param name="control_rate" value="50.0" type="double"/>

    </node>

    <!-- RViz可视化 -->
    <node name="rviz" pkg="rviz" type="rviz"
          args="-d $(find ship_painter)/rviz/ship_painter_VINS.rviz"/>

    <!-- TF变换：world到map -->
    <node pkg="tf" type="static_transform_publisher" name="world_to_map"
          args="0 0 0 0 0 0 world map 100"/>

</launch>
