<!-- 路径规划与轨迹跟踪节点，MPC控制，发布给底层飞控期望推力/期望角速度 -->

<launch>

    <arg name="traverse_clockwise" default="true"/><!--true顺时针，false逆时针-->
    <arg name="use_depth_camera" default="true"/>
    <arg name="mavros_ns" default="/mavros"/>

    <!-- 路径规划节点 (与原boat2.launch相同) -->
    <node name="ship_painter_node" pkg="ship_painter" type="ship_painter_node" output="screen">
        <param name="mavros_ns" value="$(arg mavros_ns)"/>

        <!-- STL模型路径 -->
        <param name="model_path" value="$(find ship_painter)/models/test.stl"/>

        <!-- 路径规划参数 -->
        <param name="alpha_shape_value" value="2"/>
        <param name="target_sample_count" value="500000"/>
        <param name="path_offset_distance" value="5.0"/>

        <!-- 步长设置 -->
        <param name="resample_spacing" value="0.01" type="double" />
        <param name="flight_speed" value="0.3"/>
        <param name="transition_speed" value="0.003"/>

        <!-- rviz中模型位置显示参数 -->
        <param name="display_model_x" value="3.75"/>
        <param name="display_model_y" value="-0.56"/>
        <param name="display_model_z" value="0"/>

        <!-- 喷涂参数 -->
        <param name="spray_distance" value="0.5"/>
        <param name="layer_height" value="0.25"/>

        <!-- 航点遍历方向参数 -->
        <param name="/ship_painter/traverse_clockwise" value="$(arg traverse_clockwise)"/>

        <!-- 点云可视化设置 -->
        <param name="enable_spray_visualization" value="true"/>

        <!-- Clipper -->
        <param name="use_clipper_offset" value="true"/>
        <param name="clipper_offset_precision" value="1.0"/>
        <param name="min_offset_segment_length" value="0.001"/>

        <!-- 法向量平滑插值 -->
        <param name="enable_normal_smoothing" value="false"/>

        <!-- 法向量估计参数 -->
        <param name="voxel_resolution" value="0.03"/>

        <!-- 姿态控制参数 -->
        <param name="use_position_control" value="true"/>

        <!-- 飞行参数 -->
        <param name="takeoff_height" value="2.0"/>
        <param name="waypoint_tolerance" value="0.2"/>
        <param name="orientation_tolerance" value="0.15"/>

        <param name="frame_id" value="world"/>
    </node>

    <!-- 深度相机 (可选) -->
        <!-- <group if="$(arg use_depth_camera)">
            <include file="$(find realsense2_camera)/launch/rs_camera.launch">
                <arg name="align_depth" value="true"/>
                <arg name="enable_pointcloud" value="false"/>
            </include>
        </group> -->

    <!-- MPC控制器 (输出加速度，由thrust_mapper转换) -->
    <node pkg="ship_painter" type="mpc_runner_node"
        name="mpc_runner" output="screen">

        <!-- Acados库路径 -->
        <env name="LD_LIBRARY_PATH" value="$(env HOME)/acados/lib:$(optenv LD_LIBRARY_PATH)"/>

        <!-- MAVROS命名空间 (用于订阅状态) -->
        <param name="mavros_ns" value="$(arg mavros_ns)" />

        <!-- MPC物理参数 (必须与generate_mpc.py一致) -->
        <!-- 注意: MPC输出比力(加速度 m/s²)，由thrust_mapper转换为油门 -->
        <param name="thrust_max" value="19.0" type="double"/>  <!-- 最大比力 (用于MPC约束) -->
        <param name="thrust_min" value="2.0" type="double"/>   <!-- 最小比力 -->

        <!-- 控制频率 (Hz) -->
        <param name="control_rate" value="100.0" type="double"/>

        <!-- 控制输出滤波 -->
        <!-- alpha=1.0 无滤波, alpha=0.3 强滤波 -->
        <param name="filter_alpha" value="0.6" type="double"/>

        <!-- 注意: Yaw控制已由MPC统一优化，不再需要外部PD参数 -->
    </node>

    <!-- 推力映射节点 (加速度 -> 油门) -->
    <node pkg="ship_painter" type="thrust_mapper_node"
        name="thrust_mapper" output="screen">

        <!-- 订阅MPC原始命令 -->
        <remap from="mpc_cmd" to="/ship_painter/mpc_raw_command"/>

        <!-- MAVROS命名空间 (用于发布控制指令) -->
        <param name="mavros_ns" value="$(arg mavros_ns)" />

        <!-- 飞机物理参数 -->
        <param name="mass" value="1.5" type="double"/>          <!-- 飞机质量 (kg) -->
        <param name="max_thrust_n" value="28.27" type="double"/> <!-- 电机最大拉力 (N) -->

        <!-- 油门限幅 -->
        <param name="min_throttle" value="0.05" type="double"/> <!-- 最小油门 (防止电机停转) -->
        <param name="max_throttle" value="0.95" type="double"/> <!-- 最大油门 (留安全余量) -->
    </node>

    <!-- RViz可视化 -->
    <node name="rviz" pkg="rviz" type="rviz"
          args="-d $(find ship_painter)/rviz/ship_painter_VINS.rviz"/>

    <!-- TF变换：world到map -->
    <node pkg="tf" type="static_transform_publisher" name="world_to_map"
          args="0 0 0 0 0 0 world map 100"/>

</launch>
